<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Blink LED interrupt - Button interrupt: Blink LED con interrupción de botón e interrupción de temporizador</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Blink LED interrupt - Button interrupt
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Blink LED con interrupción de botón e interrupción de temporizador </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Este proyecto hace parpadear el LED LD2 de la Nucleo-STM32F446RE a una frecuencia de <code>c</code> Hz. La frecuencia es controlada por el pulsado del botón de usuario B1. Cada vez que se pulsa el botón, la frecuencia (<code>c</code>) aumenta en 1. El LED está apagado cuando <code>c</code> es igual a 0. El botón es gestionado por una rutina de servicio de interrupción (ISR). El tiempo de parpadeo es gestionado por interrupción de temporizador.</p>
<p>El sistema usa la interrupción del temporizador 2 (TIM2) para detectar el final del tiempo de encendido o apagado del LED. La interrupción se configura con los siguientes ajustes:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parámetro </th><th class="markdownTableHeadNone">Valor  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Interrupción </td><td class="markdownTableBodyNone">TIM2_IRQHandler  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Prioridad </td><td class="markdownTableBodyNone">2  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Subprioridad </td><td class="markdownTableBodyNone">0  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md1"></a>
Ejercicio: parpadeo con interrupción del TIM2</h1>
<p><b>Cree el proyecto</b> <code>blink_led_interr_button_interr</code>. <b>Se trata de una modificación del programa</b> <code>blink_led_button_interr</code> <b>donde la acción de esperar no se toma al leer mediante <em>polling</em> el valor del</b> <code>SysTick</code> <b>para medir el tiempo pasado, sino mediante una interrupción del <em>timer</em> 2</b> (<code>TIM2</code>).</p>
<p><b>En todo momento usaremos la HAL de ST.</b></p>
<p>1 . En el fichero <code><a class="el" href="stm32f4__led_8h.html" title="Header file for the LED port layer of the STM32F4 Nucleo board.">stm32f4_led.h</a></code> completar los <code>#define</code> que faltan:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#define STM32F4_LED_TIMER TIM2</span></div>
<div class="line"><span class="preprocessor">#define STM32F4_LED_TIMER_IRQn TIM2_IRQHandler</span></div>
<div class="line"><span class="preprocessor">#define STM32F4_LED_TIMER_IRQ_PRIO</span></div>
<div class="line"><span class="preprocessor">#define STM32F4_LED_TIMER_IRQ_SUBPRIO</span></div>
</div><!-- fragment --><p>2 . En el fichero <code>stm32f4_led.c</code> hay que crear la variable global que define la estructura de tipo <code>TIM_HandleTypeDef</code> del <em>timer</em>. Use un nombre representativo, por ejemplo <code>handler_timer_led</code>:</p>
<div class="fragment"><div class="line">TIM_HandleTypeDef <a class="code" href="interr_8c.html#a36d40c0478d407554b7cbdc001da6de2">handler_timer_led</a>;</div>
</div><!-- fragment --><p>3 . <b>En el mismo fichero, crear la función</b> <code><a class="el" href="port__led_8h.html#a9c9c76e63f6012f1c146f73cb942d444" title="Configures the timer used for the delay function.">port_led_timer_setup()</a></code> <b>que inicializa la estructura</b> <em>timer</em> <b>y hacerla pública en el <code>.h</code>.</b></p>
<ul>
<li>Lo primero siempre es habilitar la <b>fuente de reloj</b> del <em>timer</em> 2:</li>
</ul>
<div class="fragment"><div class="line">__HAL_RCC_TIM2_CLK_ENABLE();</div>
</div><!-- fragment --><p>de otro modo no podrán tocar los registros del <em>timer</em>.</p><ul>
<li>En la estructura <code>handler_timer_led</code> <b>inicie los campos</b>:<ul>
<li><code>handler_timer_led.Instance</code> con el <em>timer</em> del LED que se ha definido en <code>STM32F4_LED_TIMER</code>.</li>
<li><code>handler_timer_led.Init.Prescaler</code> con el valor del <em>prescaler</em> a 0 (no se sabe todavía).</li>
<li><code>handler_timer_led.Init.Period</code> con el valor del periodo a 0 (no se sabe todavía).</li>
<li><code>handler_timer_led.Init.AutoReloadPreload</code> con el valor a <code>TIM_AUTORELOAD_PRELOAD_ENABLE</code> (para que el contador se recargue automáticamente; si no se hace, solo se contará una vez).</li>
</ul>
</li>
<li><b>Inicializar el</b> <em>timer</em> con la función <code>HAL_TIM_Base_Init()</code> pasando la dirección de la estructura <code>handler_timer_led</code>.</li>
<li><b>Activa el temporizador en modo interrupción</b> del <em>timer</em>: <code>HAL_TIM_Base_Start_IT();</code> pasando la dirección de la estructura <code>handler_timer_led</code>.</li>
<li><b>Configurar la prioridad</b> de la interrupción con la función <code>HAL_NVIC_SetPriority()</code> pasando el nombre de la IRQ del <em>timer</em>, la prioridad y la subprioridad definidas en el <code>.h</code>.</li>
<li><b>Habilitar la interrupción</b> del <em>timer</em> en el <em>NVIC</em>: <code>HAL_NVIC_EnableIRQ()</code> pasando el nombre de la IRQ del <em>timer</em> definida en <code>STM32F4_LED_TIMER_IRQn</code>.</li>
</ul>
<p>4 . <b>Crear la función</b> <code><a class="el" href="stm32f4__led_8c.html#affcaa98bca3168685a89da9f8e7f717d" title="Delays the program for a given amount of milliseconds.">port_led_timer_delay_ms(uint32_t delay_ms)</a></code> <b>que configura el tiempo de interrupción periódica del <em>timer</em> al valor</b> <code>delay_ms</code>, <b>y hacerla pública en el <code>.h</code>.</b></p>
<ul>
<li><b>Deshabilitar</b> la cuenta del <em>timer</em> para que no interrumpa, para ello llamar a la función <code>HAL_TIM_Base_Stop_IT()</code> pasando la dirección de la estructura <code>handler_timer_led</code>.</li>
<li>Poner el contador <code>CNT</code> a 0 con la función <code>__HAL_TIM_SET_COUNTER()</code> pasando la dirección de la estructura <code>handler_timer_led</code> y el valor 0.</li>
<li><b>Calcular el valor del periodo</b> (<code>ARR</code>) <b>en función del</b> <em>prescaler</em> (<code>PSC</code>).<ul>
<li>La ecuación del periodo de interrupción del <em>timer</em> es <code>T_interr = f_clk / ((PSC + 1) * (ARR + 1))</code>.</li>
<li>La frecuencia del reloj del sistema es 16 MHz y está definida en la variable <code>SystemCoreClock</code>.</li>
<li><b>Comprobar</b> que el valor del periodo <code>ARR</code> ni el <em>prescaler</em> <code>PSC</code> superan el valor máximo de 16 bits (65535). Puede hacerlo en un bucle <code>while()</code>.</li>
<li>Tener en cuenta que el valor de interrupción recibido es en milisegundos y hay que <b>convertirlo a segundos</b>.</li>
<li><b>Trabajar con precisión <code>double</code> en todas las variables y constantes.</b> <em>castear</em> los valores de la frecuencia del reloj del sistema y del periodo de interrupción a <code>double</code>. <em>e.g.</em>:<ul>
<li><code>double f_clk = (double)SystemCoreClock</code></li>
<li><code>double T_interr = (double)delay_ms / 1000.0</code></li>
<li><code>1.0</code> en lugar de <code>1</code> para que el resultado sea <code>double</code>.</li>
<li>Cuando tenga los valores de <code>PSC</code> y <code>ARR</code>, los cargamos en los campos correspondientes de la estructura <code>handler_timer_led.Init</code>:<ul>
<li><code>handler_timer_led.Init.Prescaler</code> con el valor de <code>PSC</code>.</li>
<li><code>handler_timer_led.Init.Period</code> con el valor de <code>ARR</code>.</li>
</ul>
</li>
</ul>
</li>
<li><b>Actualizar la configuración del</b> <em>timer</em> con la función <code>HAL_TIM_Base_Init()</code> pasando la dirección de la estructura <code>handler_timer_led</code>.</li>
<li><b>Forzar la actualización de registros</b> activando el bit <code>UG</code>, para ello llamar a la función <code>HAL_TIM_GenerateEvent()</code> pasando la dirección de la estructura <code>handler_timer_led</code> y el tipo de evento <code>TIM_EVENTSOURCE_UPDATE</code> (actualización). Esto hará que el <em>timer</em> recargue el valor del contador <code>CNT</code> a 0 y el valor del periodo <code>ARR</code> al nuevo valor.</li>
<li>Por último, **habilitar de nuevo la cuenta del *timer*** activando el bit <code>CEN</code> mediante la función <code>HAL_TIM_Base_Start_IT()</code> pasando la dirección de la estructura <code>handler_timer_led</code>.</li>
</ul>
</li>
</ul>
<p>5 . <b>En el fichero</b> <code>interr.c</code>, donde están las variables globales, <b>declarar la variable</b> <code>handler_timer_led</code> <b>como</b> <code>extern</code>. Esto le dice al compilador que la variable está definida en otro fichero y que no la defina de nuevo. La declaración debe ser:</p>
<div class="fragment"><div class="line"><span class="keyword">extern</span> TIM_HandleTypeDef <a class="code" href="interr_8c.html#a36d40c0478d407554b7cbdc001da6de2">handler_timer_led</a>;</div>
</div><!-- fragment --><p>6 . <b>Implementar la función</b> <code><a class="el" href="interr_8c.html#a38ad4725462bdc5e86c4ead4f04b9fc2" title="Interrupt service routine for the Timer 2 (TIM2).">TIM2_IRQHandler()</a></code> <b>que se ejecuta cuando se produce la interrupción del <em>timer</em> 2.</b></p>
<ul>
<li>Llamar a la función <code>HAL_TIM_IRQHandler()</code> pasando la dirección de la estructura <code>handler_timer_led</code>. Esto limpiará el bit <code>UIF</code> del registro <code>SR</code> y llamará automáticamente a la función de <em>Callback</em> <code><a class="el" href="interr_8c.html#af8a882d847dbd5750599ef2101383ad3" title="Timer period elapsed callback in non blocking mode.">HAL_TIM_PeriodElapsedCallback()</a></code> que es la que está relacionada con la interrupción que haya sucedido; en nuestro caso, llamará a la de fin de periodo de interrupción.</li>
</ul>
<p>7 . <b>Implementar la función</b> <code><a class="el" href="interr_8c.html#af8a882d847dbd5750599ef2101383ad3" title="Timer period elapsed callback in non blocking mode.">HAL_TIM_PeriodElapsedCallback()</a></code> <b>en el mismo fichero.</b></p><ul>
<li>Lo primero es <b>comprobar</b> que la interrupción que ha sucedido es la de fin de periodo del <em>timer</em> del LED, <em>i.e.</em>:</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (handler_tim-&gt;Instance == <a class="code" href="stm32f4__led_8h.html#ae4e9adc68624a998093fdd9bcb37e998">STM32F4_LED_TIMER</a>)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// Código de la interrupción del timer del LED</span></div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li>Si es nuestro <em>timer</em> el que ha interrumpido, llamar a la función <code><a class="el" href="port__led_8h.html#ac032ee1518a130c95ba3ef7fff5d0ddc" title="Toggles the LED state.">port_led_toggle()</a></code> para cambiar el estado del LED <b>solo si el contador de pulsaciones <code>c</code> es mayor que 0.</b></li>
<li>Gestionar el indicador de botón pulsado <code>button_pressed</code> adecuadamente.</li>
</ul>
<p>8 . <b>En la <code>HAL_GPIO_EXTI_Callback</code> del botón, llamar a la función</b> <code><a class="el" href="port__led_8h.html#affcaa98bca3168685a89da9f8e7f717d" title="Delays the program for a given amount of milliseconds.">port_led_timer_delay_ms()</a></code> con el valor adecuado para el parpadeo del LED.</p>
<p>Como puede ver, como ya no hay que hacer espera activa, ya no hay que llamar a <code><a class="el" href="port__system_8h.html#ae6ca17ba9c9d055d442cf1e4a73be046" title="Delays the program execution for the specified number of milliseconds.">port_system_delay_ms()</a></code> en la función <code><a class="el" href="main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4" title="Main function.">main()</a></code>. En su lugar, se llama a <code><a class="el" href="port__led_8h.html#affcaa98bca3168685a89da9f8e7f717d" title="Delays the program for a given amount of milliseconds.">port_led_timer_delay_ms()</a></code>, que es la que configura el <em>timer</em> para que interrumpa cada <code>delay_ms</code> milisegundos.</p>
<p>9 . <b>Por último, en</b> <code>main.c</code>:</p>
<ul>
<li><b>Quitar</b> del <code><a class="el" href="main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4" title="Main function.">main()</a></code> la gestión del parpadeo del LED.</li>
<li>Como las variables <code>c</code> y <code>button_pressed</code> se gestionan en las ISRs, <b>quitamos su declaración y en</b> <code>interr.c</code> <b>ya no hace falta declararlas como</b> <code>extern</code>; <b>quítelo</b>.</li>
<li><b>Llamar a la función</b> <code><a class="el" href="port__led_8h.html#a9c9c76e63f6012f1c146f73cb942d444" title="Configures the timer used for the delay function.">port_led_timer_setup()</a></code> en el <code><a class="el" href="main_8c.html#ae66f6b31b5ad750f1fe042a706a4e3d4" title="Main function.">main()</a></code> para inicializar el <em>timer</em> que controla el parpadeo del LED. El bucle <code>while(1)</code> <b>ya no tiene que hacer nada</b>. El parpadeo del LED se hace en la ISR del <em>timer</em>.</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
References</h1>
<ul>
<li><b>[1]</b>: <a href="https://oa.upm.es/88460">Fundamentos teóricos de sistemas basados en microcontrolador STM32. Sistemas Digitales II, Sistemas Electrónicos</a></li>
<li><b>[2]</b>: <a href="https://web.eece.maine.edu/~zhu/book/index.php">Embedded Systems with ARM Cortex-M Microcontrollers in Assembly Language and C (Fourth Edition)</a> for explanations and examples of use of the ARM Cortex-M microcontrollers in C with CMSIS.</li>
<li><b>[3]</b>: <a href="https://ingenio.upm.es/primo-explore/fulldisplay?docid=34UPM_ALMA51126621660004212&amp;context=L&amp;vid=34UPM_VU1&amp;lang=es_ES&amp;search_scope=TAB1_SCOPE1&amp;adaptor=Local%20Search%20Engine&amp;tab=tab1&amp;query=any,contains,Programming%20with%20STM32:%20Getting%20Started%20with%20the%20Nucleo%20Board%20and%20C%2FC%2B%2B&amp;offset=0">Programming with STM32: Getting Started with the Nucleo Board and C/C++</a> for examples of use of the STM32 microcontrollers with the HAL of ST.</li>
<li><b>[4]</b>: <a href="https://ingenio.upm.es/primo-explore/fulldisplay?docid=34UPM_ALMA2151866130004212&amp;context=L&amp;vid=34UPM_VU1&amp;lang=es_ES&amp;search_scope=TAB1_SCOPE1&amp;adaptor=Local%20Search%20Engine&amp;isFrbr=true&amp;tab=tab1&amp;query=any,contains,C%20Programming%20Language">The C Programming Language</a></li>
<li><b>[5]</b>: <a href="https://www.elektor.com/products/nucleo-boards-programming-with-the-stm32cubeide">Nucleo Boards Programming with th STM32CubeIDE</a> for examples of use of the STM32 microcontrollers with the STM32CubeIDE. </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="ainterr_8c_html_a36d40c0478d407554b7cbdc001da6de2"><div class="ttname"><a href="interr_8c.html#a36d40c0478d407554b7cbdc001da6de2">handler_timer_led</a></div><div class="ttdeci">TIM_HandleTypeDef handler_timer_led</div><div class="ttdef"><b>Definition:</b> stm32f4_led.c:20</div></div>
<div class="ttc" id="astm32f4__led_8h_html_ae4e9adc68624a998093fdd9bcb37e998"><div class="ttname"><a href="stm32f4__led_8h.html#ae4e9adc68624a998093fdd9bcb37e998">STM32F4_LED_TIMER</a></div><div class="ttdeci">#define STM32F4_LED_TIMER</div><div class="ttdef"><b>Definition:</b> stm32f4_led.h:19</div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
